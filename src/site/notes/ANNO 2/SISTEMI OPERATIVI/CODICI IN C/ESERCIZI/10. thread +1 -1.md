---
{"dg-publish":true,"permalink":"/anno-2/sistemi-operativi/codici-in-c/esercizi/10-thread-1-1/"}
---

>[!tip] consegna
> 
> Scrivere un programma C che segue le seguenti specifiche:
> 
> - Il programma crea un buffer come array di `11` numeri interi, inizializzati a zero.
> - Genera tre thread:
>     - Il primo thread sceglie casualmente una cella del buffer e vi scrive il numero `+1`.
>     - Il secondo thread sceglie casualmente una cella del buffer e vi scrive il numero `-1`.
>     - Il terzo thread controlla se tutte le celle del buffer sono state inizializzate. In caso positivo, determina se il numero di celle contenenti `+1` è maggiore di quelle con `-1` e termina tutti i thread.
>     - Mentre un thread accede al buffer, nessun altro deve accedervi. Ogni thread attende un tempo random tra `0` e `3` secondi.

```c
#include<stdio.h>

#include<stdlib.h>

#include<unistd.h>

#include<fcntl.h>

#include<time.h>

#include<pthread.h>

pthread_mutex_t mutex;

int buffer[11]={0};

int termina=0;

  

void *thread1(void *ptr)

{

    while(1)

    {

        pthread_mutex_lock(&mutex);

        if(termina)

        {

            pthread_mutex_unlock(&mutex);

            pthread_exit(NULL);

        }

        int pos=rand()%11;

        printf("ho scritto nel buffer +1 nella pos %d \n",pos);

        buffer[pos]=+1;

        pthread_mutex_unlock(&mutex);

        sleep(rand()%4);

    }

}

void *thread2(void *ptr)

{

    while(1)

    {

    pthread_mutex_lock(&mutex);

    if(termina)

    {

        pthread_mutex_unlock(&mutex);

        pthread_exit(NULL);

    }

    int pos=rand()%11;

    printf("ho scritto nel buffer -1 nella pos %d\n",pos);

    buffer[pos]=-1;

    pthread_mutex_unlock(&mutex);

    sleep(rand()%4);

    }

}

void *thread3(void *ptr)

{

    pthread_mutex_lock(&mutex);

    printf("controllo se il buffer è inizializzato \n");

    for(int i=0;i<11;i++)

    {

        if(buffer[i]!=0)

        {

            printf("buffer non inizializzato \n");

            pthread_mutex_unlock(&mutex);

            termina=1;

            pthread_exit(NULL);

        }

    }

    printf("buffer correttamente inizializzato \n");

    pthread_mutex_unlock(&mutex);

    while(1)

    {

    pthread_mutex_lock(&mutex);

  

    int contap=0,contam=0;

        for(int i=0;i<11;i++)

        {

            if(buffer[i]==+1) contap++;

            else contam++;

        }

        if(contap>contam)

        {

            printf("contap>contam \n");

            termina=1;

            for(int i=0;i<11;i++)

            {

                printf(" ecco l'array %d \n",buffer[i]);

            }

            pthread_mutex_unlock(&mutex);

            pthread_exit(0);

        }

        else printf("niente \n");

    pthread_mutex_unlock(&mutex);

    sleep(rand()%4);

    }

}

  
  

int main(int argc, char **argv)

{

    pthread_t t1,t2,t3;

    pthread_mutex_init(&mutex,NULL);

    pthread_create(&t3,NULL,thread3,NULL);

    pthread_create(&t1,NULL,thread1,NULL);

    pthread_create(&t2,NULL,thread2,NULL);

    pthread_join(t3,NULL);

    pthread_join(t1,NULL);

    pthread_join(t2,NULL);

    pthread_mutex_destroy(&mutex);

  

    return 0;

}
```